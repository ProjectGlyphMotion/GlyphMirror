<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Access - Project GlyphMirror</title>
    <meta name="description" content="Apply for or check the status of your application for Project GlyphMirror.">
    <link rel="icon" type="image/x-icon" href="images/project-glyph-motion.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
    // --- Redirect from GitHub Pages to Custom Domain ---

    // 1. Define the specific hostnames and repository path
    const githubPagesHostname = "projectglyphmotion.github.io";
    const repoPath = "/GlyphMirror";
    const customDomain = "mirror.projectglyphmotion.studio";
    
    // 2. Get the current hostname and path where the script is running
    const currentHostname = window.location.hostname;
    const currentPath = window.location.pathname;

    // 3. Check if the user is on the default GitHub Pages URL for this specific repository
    if (currentHostname === githubPagesHostname && currentPath.toLowerCase().startsWith(repoPath.toLowerCase())) {
        // 4. Construct the new path by removing the repository name from the start
        const newPath = currentPath.substring(repoPath.length);
        
        // 5. If they are, redirect them to the same page on your custom domain
        const newUrl = `https://${customDomain}${newPath || '/'}${window.location.search}${window.location.hash}`;
        window.location.replace(newUrl);
    }
    </script>

    <style>
        /* Styles are kept the same for UI consistency */
        body { font-family: 'Inter', sans-serif; background-color: #0B0A0F; color: #EDEDF3; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; overflow-x: hidden; }
        .background-glow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; overflow: hidden; pointer-events: none; }
        .glow-element { position: absolute; border-radius: 50%; opacity: 0.2; mix-blend-mode: screen; filter: blur(100px); will-change: transform, opacity; }
        .glow-1 { width: clamp(400px, 60vw, 800px); height: clamp(400px, 60vw, 800px); background: radial-gradient(circle at center, #FDA136 0%, rgba(253, 161, 54, 0) 70%); filter: blur(120px); top: -20%; left: -15%; animation: subtleDrift 35s infinite alternate ease-in-out; }
        .glow-2 { width: clamp(350px, 50vw, 700px); height: clamp(350px, 50vw, 700px); background: radial-gradient(circle at center, #FF5733 0%, rgba(255, 87, 51, 0) 70%); filter: blur(100px); bottom: -15%; right: -10%; animation: subtleDrift 40s infinite alternate-reverse ease-in-out 2s; }
        @keyframes subtleDrift { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(calc(8vw - 20px), calc(8vh - 10px)) scale(1.2); } }
        .content-card { background-color: rgba(10, 10, 15, 0.85); border: 1px solid rgba(253, 161, 54, 0.25); border-radius: 0.75rem; color: #EDEDF3; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; z-index: 10; }
        .page-title { font-family: 'Press Start 2P', cursive; font-weight: normal; background: linear-gradient(to right, #FDA136, #FFD700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 3px rgba(0,0,0,0.3); }
        .info-banner { background-color: rgba(253, 161, 54, 0.1); border: 1px solid rgba(253, 161, 54, 0.3); color: #FED7AA; border-left-width: 4px; border-left-color: #FDA136; }
        .info-banner.error-banner { background-color: rgba(255, 0, 0, 0.1); border-color: rgba(255, 0, 0, 0.3); border-left-color: #FF5733; color: #FFD7D7; }
        .info-banner.success-banner { background-color: rgba(52, 211, 153, 0.1); border-color: rgba(52, 211, 153, 0.3); border-left-color: #34D399; color: #C6F6D5; }
        .btn { @apply font-semibold py-2 px-4 shadow-md transition-transform duration-300; border-radius: 10px; position: relative; overflow: hidden; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease; }
        .btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 8px 15px rgba(0,0,0,0.4); }
        .btn::after { content: ''; position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.3); animation: ripple 0.6s linear forwards; opacity: 0; transform: scale(0); pointer-events: none; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); }
        .btn.clicked::after { animation: ripple 0.6s linear forwards; }
        @keyframes ripple { 0% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        .btn-custom-primary { @apply bg-gradient-to-br from-orange-500 to-amber-500 text-white focus:ring-orange-400 shadow-orange-600/40 hover:from-orange-600 hover:to-amber-600; box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2); }
        .btn-nav { box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2); }
        .btn-nav:hover { box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2), 0 8px 15px rgba(0,0,0,0.4), 0 0 10px rgba(253, 161, 54, 0.5); }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px; transition: background-color 0.3s ease; }
        .status-dot.online { background-color: #34D399; animation: pulseDot 1.5s infinite ease-in-out; }
        .status-dot.offline { background-color: #EF4444; }
        .status-dot.checking { background-color: #FFD700; animation: pulseDot 1.5s infinite ease-in-out; }
        @keyframes pulseDot { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        .status-tag { @apply inline-block px-3 py-1 text-sm font-semibold rounded-full; }
        .status-pending { @apply bg-yellow-500/20 text-yellow-300; }
        .status-approved { @apply bg-green-500/20 text-green-300; }
        .status-rejected { @apply bg-red-500/20 text-red-300; }
    </style>
</head>
<body class="min-h-screen py-8 px-4">
    <div class="background-glow-container">
        <div class="glow-element glow-1"></div>
        <div class="glow-element glow-2"></div>
    </div>

    <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-5xl mx-auto content-card p-8 md:p-12 shadow-2xl relative z-10">
            <header class="mb-10 text-center">
                <h1 class="text-2xl sm:text-3xl md:text-4xl page-title mb-6">Application Portal</h1>
                <p class="text-center text-slate-300">Submit a new application or check the status of an existing one.</p>
                <p id="serverStatus" class="text-center text-slate-300 text-sm font-medium flex items-center justify-center mt-4 mb-6">
                    <span id="statusDot" class="status-dot"></span>
                    Server Status: <span id="statusText">Checking...</span>
                </p>
                <div class="flex justify-center">
                    <a href="index.html" class="btn btn-custom-primary btn-nav py-2 px-4 text-sm"><i class="fas fa-arrow-left mr-2"></i> Go Back to Home</a>
                </div>
            </header>

            <!-- Status Check Section -->
            <div id="statusCheckSection" class="mb-10">
                <h2 class="text-xl font-bold text-center mb-4">Check Application Status</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                    <input type="email" id="statusEmail" placeholder="Enter your application email" class="w-full sm:w-auto flex-grow px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner">
                    <button id="checkStatusBtn" class="btn btn-custom-primary w-full sm:w-auto">Check Status</button>
                </div>
            </div>

            <!-- Application Status Display -->
            <div id="applicationStatusDisplay" class="hidden mb-10 p-6 bg-slate-800/50 border border-orange-500/30 rounded-lg">
                <h3 class="text-lg font-semibold mb-4">Application Details</h3>
                <div id="statusDetails" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm"></div>
            </div>
            
            <!-- Already Applied Section -->
            <div id="alreadyAppliedSection" class="hidden text-center mb-10 p-6 bg-slate-800/50 border border-orange-500/30 rounded-lg">
                <p class="mb-4">You have already submitted an application with this email. Only one application per person is allowed.</p>
                <button id="applyForAnotherBtn" class="btn btn-custom-primary">Apply for Another Person</button>
            </div>

            <!-- Not Found Section -->
            <div id="notFoundSection" class="hidden text-center mb-10 p-6 bg-slate-800/50 border border-orange-500/30 rounded-lg">
                <p id="notFoundText" class="mb-4">No application found for this email.</p>
                <button id="createFromNotFoundBtn" class="btn btn-custom-primary">Create a New Application</button>
            </div>

            <!-- Application Form -->
            <div id="applicationFormWrapper">
                <h2 class="text-xl font-bold text-center mb-4 border-t border-slate-700 pt-8">New Application</h2>
                <form id="applicationForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 md:gap-x-6 md:gap-y-6 space-y-6 md:space-y-0">
                        <div>
                            <label for="name" class="block text-sm font-medium text-slate-300 mb-2">Full Name</label>
                            <input type="text" id="name" name="name" placeholder="Enter your full name" class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner" required>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-slate-300 mb-2">Contact Email</label>
                            <input type="email" id="email" name="email" placeholder="Enter your email address" class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner" required>
                        </div>
                        <div>
                            <label for="username" class="block text-sm font-medium text-slate-300 mb-2">Desired Username</label>
                            <input type="text" id="username" name="username" placeholder="Choose a unique username" class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner" required pattern="^[a-zA-Z0-9._\-]{3,20}$" title="Username must be 3-20 characters and can contain letters, numbers, and . _ -">
                            <p class="text-xs text-slate-400 mt-1">3-20 characters. Letters, numbers, and . _ - are allowed.</p>
                        </div>
                        <div>
                            <label for="telegram" class="block text-sm font-medium text-slate-300 mb-2">Telegram Username (Optional)</label>
                            <input type="text" id="telegram" name="telegram" placeholder="@your_telegram_handle" class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner">
                        </div>
                    </div>
                    <div>
                        <label for="reason" class="block text-sm font-medium text-slate-300 mb-2">Reason for Access</label>
                        <textarea id="reason" name="reason" rows="4" placeholder="Briefly explain why you need access and what you plan to store." class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm placeholder-slate-400 shadow-inner" required></textarea>
                    </div>
                    <div>
                        <label for="storage" class="block text-sm font-medium text-slate-300 mb-2">Estimated Initial Storage</label>
                        <select id="storage" name="storage" class="mt-1 block w-full px-4 py-2 border border-orange-500/40 bg-slate-800 text-EDEDF3 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-150 ease-in-out text-sm">
                            <option value="10">10 GB</option> <option value="25">25 GB</option> <option value="50">50 GB</option> <option value="75">75 GB</option> <option value="100">100 GB</option>
                        </select>
                    </div>
                    <button type="submit" id="submitButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-lg font-medium btn btn-custom-primary">Submit Application</button>
                </form>
            </div>

            <div id="statusMessage" class="mt-6 p-4 info-banner rounded-lg hidden text-sm flex items-start">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 inline-block mr-3 flex-shrink-0"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg>
                <p id="messageText" class="font-medium"></p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const applicationForm = document.getElementById('applicationForm');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const messageText = document.getElementById('messageText');
        const serverStatusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        const statusEmailInput = document.getElementById('statusEmail');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const applicationStatusDisplay = document.getElementById('applicationStatusDisplay');
        const statusDetails = document.getElementById('statusDetails');
        const applicationFormWrapper = document.getElementById('applicationFormWrapper');
        const statusCheckSection = document.getElementById('statusCheckSection');
        const notFoundSection = document.getElementById('notFoundSection');
        const notFoundText = document.getElementById('notFoundText');
        const createFromNotFoundBtn = document.getElementById('createFromNotFoundBtn');
        const alreadyAppliedSection = document.getElementById('alreadyAppliedSection');
        const applyForAnotherBtn = document.getElementById('applyForAnotherBtn');

        // --- Dynamic Backend Configuration ---
        // This block works for local testing (opening the file directly) and for the live deployed site.
        const isLocal = window.location.protocol === 'file:' || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
        const BACKEND_URL = isLocal ? 'http://127.0.0.1:5000' : 'https://api.mirror.projectglyphmotion.studio';

        // --- Universal Constants (used across multiple files) ---
        // Define all constants here so they are available in every file, preventing ReferenceErrors.
        const POLLING_INTERVAL_SERVER_HEALTH = 10000; // A consistent interval for health checks.
        const HEALTH_STATUS_ENDPOINT = `${BACKEND_URL}/status`;

        // --- Page-Specific Endpoint Constants ---
        // For apply.html
        const API_ENDPOINT = `${BACKEND_URL}/apply-form`;
        const STATUS_API_ENDPOINT = `${BACKEND_URL}/api/application/status`;

        // For admin_login.html
        const CONFIG_ENDPOINT = `${BACKEND_URL}/api/auth/config`;
        const LOGIN_ENDPOINT = `${BACKEND_URL}/api/auth/admin_login`;

        // --- Server Health Check ---
        async function checkServerHealth() {
            try {
                const response = await fetch(HEALTH_STATUS_ENDPOINT, { method: 'HEAD' });
                if (response.ok) {
                    serverStatusText.textContent = 'Online';
                    statusDot.classList.remove('offline', 'checking');
                    statusDot.classList.add('online');
                } else { throw new Error('Server responded with an error'); }
            } catch (error) {
                serverStatusText.textContent = 'Offline';
                statusDot.classList.remove('online', 'checking');
                statusDot.classList.add('offline');
            }
        }

        // --- Main Logic ---
        const fetchAndDisplayStatus = async (email, isMyApplication = false) => {
            if (!email) return;
            showMessage('Checking status...', 'info');
            try {
                const response = await fetch(`${STATUS_API_ENDPOINT}?email=${encodeURIComponent(email)}`);
                if (response.status === 404) {
                    showNotFoundState(email, isMyApplication);
                    return;
                }
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Could not fetch status.');
                
                displayApplicationDetails(data, isMyApplication);
                hideMessage();
                
            } catch (error) {
                showMessage(error.message, 'error');
                if (!isMyApplication) resetToInitialState();
            }
        };

        const displayApplicationDetails = (data, isMyApplication) => {
            const statusClass = `status-${data.status.toLowerCase()}`;
            statusDetails.innerHTML = `
                <div><strong class="text-slate-400">Name:</strong><p>${data.name}</p></div>
                <div><strong class="text-slate-400">Email:</strong><p>${data.email}</p></div>
                <div><strong class="text-slate-400">Username:</strong><p>${data.username}</p></div>
                <div><strong class="text-slate-400">Submitted:</strong><p>${new Date(data.submitted_at).toLocaleString()}</p></div>
                <div class="sm:col-span-2"><strong class="text-slate-400">Status:</strong> <span class="status-tag ${statusClass}">${data.status}</span></div>
            `;
            applicationStatusDisplay.classList.remove('hidden');
            
            if (isMyApplication) {
                applicationFormWrapper.classList.add('hidden');
                statusCheckSection.classList.add('hidden');
                alreadyAppliedSection.classList.remove('hidden');
            }
        };
        
        const showNotFoundState = (email, isMyApplication) => {
            if (isMyApplication) {
                // This case shouldn't happen if logic is correct, but as a fallback:
                resetToInitialState();
                return;
            }
            notFoundText.textContent = `No application found for "${email}".`;
            applicationFormWrapper.classList.add('hidden');
            applicationStatusDisplay.classList.add('hidden');
            alreadyAppliedSection.classList.add('hidden');
            notFoundSection.classList.remove('hidden');
            hideMessage();
        };

        const resetToInitialState = () => {
            applicationFormWrapper.classList.remove('hidden');
            statusCheckSection.classList.remove('hidden');
            applicationStatusDisplay.classList.add('hidden');
            notFoundSection.classList.add('hidden');
            alreadyAppliedSection.classList.add('hidden');

            localStorage.removeItem('myApplicationEmail');
            localStorage.removeItem('lastCheckedEmail');
            statusEmailInput.value = '';
            applicationForm.reset();
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Application';
            hideMessage();
        };

        // --- Event Listeners ---
        checkStatusBtn.addEventListener('click', () => {
            const email = statusEmailInput.value.trim();
            if (email) {
                localStorage.setItem('lastCheckedEmail', email);
                // When checking manually, it's never "my application"
                fetchAndDisplayStatus(email, false);
            } else {
                showMessage('Please enter an email to check status.', 'error');
            }
        });
        
        applyForAnotherBtn.addEventListener('click', resetToInitialState);
        
        createFromNotFoundBtn.addEventListener('click', () => {
            const lastChecked = localStorage.getItem('lastCheckedEmail');
            resetToInitialState();
            if (lastChecked) {
                document.getElementById('email').value = lastChecked;
            }
        });

        applicationForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            submitButton.disabled = true;
            submitButton.innerHTML = 'Submitting...';
            
            const formData = new FormData(applicationForm);
            const applicationData = Object.fromEntries(formData.entries());
            applicationData.storage = parseInt(applicationData.storage, 10);

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(applicationData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'An unknown error occurred.');
                
                localStorage.setItem('myApplicationEmail', applicationData.email);
                await fetchAndDisplayStatus(applicationData.email, true);
                showMessage('Application submitted! Your current status is shown below.', 'success');

            } catch (error) {
                showMessage(error.message, 'error');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Application';
            }
        });

        // --- Utility Functions ---
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            statusMessage.classList.remove('hidden', 'success-banner', 'error-banner', 'info-banner');
            statusMessage.classList.add(`${type}-banner`);
        }
        function hideMessage() {
            statusMessage.classList.add('hidden');
        }

        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            checkServerHealth();
            setInterval(checkServerHealth, 5000);
            
            const myAppEmail = localStorage.getItem('myApplicationEmail');
            if (myAppEmail) {
                fetchAndDisplayStatus(myAppEmail, true);
            } else {
                const lastCheckedEmail = localStorage.getItem('lastCheckedEmail');
                if (lastCheckedEmail) {
                    statusEmailInput.value = lastCheckedEmail;
                }
            }
        });
    </script>
</body>
</html>
